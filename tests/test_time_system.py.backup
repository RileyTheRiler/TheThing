import pytest
import sys
import os

# Add src directory to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "..", "src"))

from systems.architect import TimeSystem
from core.event_system import event_bus, EventType, GameEvent

class MockGameState:
    def __init__(self, power_on=True):
        self.power_on = power_on

class TestTimeSystem:
    def test_hour_initialization(self):
        """Test default and custom start hours."""
        ts = TimeSystem(start_hour=19)
        assert ts.hour == 19
        assert ts.turn_count == 0

        ts_custom = TimeSystem(start_hour=10)
        assert ts_custom.hour == 10

    def test_hour_rollover(self):
        """Test that hour wraps around 24 correctly using turn count."""
        ts = TimeSystem(start_hour=23)
        assert ts.hour == 23
        
        # Advance 1 turn -> 00:00
        ts.turn_count = 1
        assert ts.hour == 0
        
        # Advance to turn 2 -> 01:00
        ts.turn_count = 2
        assert ts.hour == 1
        
        # Large turn count
        ts.turn_count = 25  # 23 + 25 = 48 -> 00:00
        assert ts.hour == 0

    def test_event_subscription(self):
        """Test that TimeSystem responds to TURN_ADVANCE events."""
        ts = TimeSystem(start_hour=12)
        initial_turn = ts.turn_count
        
        event = GameEvent(EventType.TURN_ADVANCE, {"game_state": MockGameState(power_on=True)})
        event_bus.emit(event)
        
        assert ts.turn_count == initial_turn + 1
        assert ts.hour == 13
        
        ts.cleanup()

    def test_thermal_decay(self):
        """Test temperature changes based on power state via update_environment (triggered by event)."""
        ts = TimeSystem(start_temp=10)
        
        # Power ON -> Temperature increases (heating)
        # Mock event with power ON
        event_on = GameEvent(EventType.TURN_ADVANCE, {"game_state": MockGameState(power_on=True)})
        event_bus.emit(event_on)
        # 10 + 2 = 12
        assert ts.temperature == 12
        
        # Power OFF -> Temperature drops drastically
        event_off = GameEvent(EventType.TURN_ADVANCE, {"game_state": MockGameState(power_on=False)})
        event_bus.emit(event_off)
        # 12 - 5 = 7
        assert ts.temperature == 7
        
        ts.cleanup()

    def test_serialization(self):
        """Test to_dict and from_dict."""
        ts = TimeSystem(start_temp=-20, start_hour=18)
        ts.turn_count = 5
        
        data = ts.to_dict()
        assert data["temperature"] == -20
        assert data["start_hour"] == 18
        assert data["turn_count"] == 5
        
        restored = TimeSystem.from_dict(data)
        assert restored.temperature == -20
        assert restored.start_hour == 18
        assert restored.turn_count == 5
        # 18 + 5 = 23
        assert restored.hour == 23

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
